== FILE / FOLDER STRUCTURE (relative to /Users/samueltownsend/dev/cosmic/Advanced-Rag-Microservices/services/frontend) ==
./
public/
src/
src/assets/
src/components/
src/components/ui/
src/lib/
src/pages/
.gitignore
Dockerfile
README.md
components.json
eslint.config.js
index.html
package.json
src/App.css
src/App.tsx
src/MainContent.tsx
src/components/ChartBrowser.tsx
src/components/Dashboard.tsx
src/components/SideBar.tsx
src/components/SourceViewer.tsx
src/components/ui/accordion.tsx
src/components/ui/button.tsx
src/components/ui/card.tsx
src/components/ui/input.tsx
src/components/ui/progress.tsx
src/components/ui/resizable.tsx
src/components/ui/scroll-area.tsx
src/components/ui/select.tsx
src/components/ui/separator.tsx
src/components/ui/skeleton.tsx
src/components/ui/tabs.tsx
src/index.css
src/lib/api.ts
src/lib/utils.ts
src/main.tsx
src/pages/HowItWorks.tsx
src/types.ts
tailwind.config.js
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts


== CONCATENATED FILE CONTENTS ==

---- FILE: .gitignore ----
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

*.DS_Store

---- FILE: Dockerfile ----
# Use an official Node runtime as a parent image
FROM node:20-alpine

# Set the working directory
WORKDIR /app

# Copy package.json and package-lock.json
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy the rest of the application code
COPY . .

# Expose the port Vite runs on
EXPOSE 5173

# Start the development server
# Note: The actual command is overridden in docker-compose.yml 
# to ensure the host binding works (npm run dev -- --host)
CMD ["npm", "run", "dev", "--", "--host"]

---- FILE: README.md ----
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```


---- FILE: components.json ----
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}


---- FILE: eslint.config.js ----
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


---- FILE: index.html ----
<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/src/assets/doggie.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision RAG</title>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>

---- FILE: package.json ----
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@radix-ui/react-accordion": "^1.2.0",
    "@radix-ui/react-collapsible": "^1.1.0",
    "@radix-ui/react-progress": "^1.1.0",
    "@radix-ui/react-scroll-area": "^1.1.0",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.0",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-tabs": "^1.1.0",
    "@tanstack/react-query": "^5.51.0",
    "axios": "^1.7.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "lucide-react": "^0.400.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-markdown": "^9.0.1",
    "react-resizable-panels": "^2.0.19",
    "react-router-dom": "^7.12.0",
    "tailwind-merge": "^2.4.0",
    "tailwindcss-animate": "^1.0.7",
    "tw-animate-css": "^1.4.0"
  },
  "devDependencies": {
    "@tailwindcss/vite": "^4.0.0",
    "@types/node": "^20.14.0",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.39",
    "tailwindcss": "^4.0.0",
    "typescript": "^5.5.3",
    "vite": "^5.3.4"
  }
}


---- FILE: src/App.css ----
App-specific layout and component styles
/* These work with the Tailwind theme and respect dark mode automatically */

#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
}

/* Logo animations */
.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms ease;
}

.logo:hover {
  filter: drop-shadow(0 0 2em hsl(var(--primary) / 0.6));
}

.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

/* Card component - uses theme colors */
.card {
  padding: 2em;
  background-color: hsl(var(--card));
  color: hsl(var(--card-foreground));
  border: 1px solid hsl(var(--border));
  border-radius: var(--radius);
  transition: all 0.2s ease;
}

.card:hover {
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}

/* Documentation text */
.read-the-docs {
  color: hsl(var(--muted-foreground));
  font-size: 0.875rem;
}

/* Center content helper */
.center-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
}

---- FILE: src/App.tsx ----
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { Dashboard } from './components/Dashboard';
import { HowItWorks } from './pages/HowItWorks';

const queryClient = new QueryClient();

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        <Routes>
          <Route path="/" element={<Dashboard />} />
          <Route path="/how-it-works" element={<HowItWorks />} />
        </Routes>
      </BrowserRouter>
    </QueryClientProvider>
  );
}

export default App;

---- FILE: src/MainContent.tsx ----
import React, { useState, useEffect, useRef } from 'react';
import { useQuery, useMutation } from '@tanstack/react-query';
import ReactMarkdown from 'react-markdown';
import { Send, FileText, Loader2 } from 'lucide-react';
import { Link } from 'react-router-dom'; // <--- Add this import

import { fetchSessionDocuments, sendQuery, getSessionHistory } from './lib/api';
import { ChatMessage } from './types';
import { SourceViewer } from './components/SourceViewer';
// REMOVED: import { ChartBrowser } ...

// UI Components
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';

// Assets
import doggieSrc from './assets/doggie.svg';
import userSrc from './assets/user.svg';

const WelcomeScreen = () => (
    <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-muted/10 rounded-xl m-4">
        <div className="mb-6 h-24 w-24 bg-primary/10 rounded-full flex items-center justify-center">
            <img src={doggieSrc} alt="Smart RAG" className="h-16 w-16" />
        </div>
        <h2 className="text-3xl font-bold mb-4">ðŸ‘‹ Welcome to Smart RAG</h2>
        <p className="text-lg text-muted-foreground mb-4 max-w-md">
            Upload a document or load a past session from the sidebar to begin.
        </p>

        {/* ADD THIS LINK */}
        <Link to="/how-it-works">
            <Button variant="link" className="text-primary gap-1 text-base">
                How it works <span aria-hidden="true">&rarr;</span>
            </Button>
        </Link>
    </div>
);
export const MainContent = ({ sessionId }: { sessionId: string | null }) => {
    const [chatHistory, setChatHistory] = useState<ChatMessage[]>([]);
    const [input, setInput] = useState("");
    const scrollRef = useRef<HTMLDivElement>(null);
    const bottomRef = useRef<HTMLDivElement>(null);

    const { data: documents = [] } = useQuery({
        queryKey: ['documents', sessionId],
        queryFn: () => fetchSessionDocuments(sessionId!),
        enabled: !!sessionId,
    });

    const { data: serverHistory } = useQuery({
        queryKey: ['history', sessionId],
        queryFn: () => getSessionHistory(sessionId!),
        enabled: !!sessionId,
    });

    useEffect(() => {
        if (serverHistory && Array.isArray(serverHistory)) {
            const formatted: ChatMessage[] = serverHistory.flatMap((item: any) => [
                { role: 'user', content: item.question },
                { role: 'assistant', content: item.response, sources: item.sources || item.results || [] }
            ]);
            setChatHistory(formatted);
        } else if (sessionId && !serverHistory) {
            setChatHistory([]);
        }
    }, [serverHistory, sessionId]);

    const sendMessageMutation = useMutation({
        mutationFn: async (question: string) => {
            if (!sessionId) throw new Error("No Session");
            return await sendQuery(sessionId, question);
        },
        onSuccess: (data) => {
            setChatHistory(prev => [
                ...prev,
                { role: 'assistant', content: data.response, sources: data.results }
            ]);
        },
        onError: (error) => {
            setChatHistory(prev => [
                ...prev,
                { role: 'assistant', content: `Error: ${error.message}` }
            ]);
        }
    });

    useEffect(() => {
        setTimeout(() => {
            bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }, [chatHistory, sendMessageMutation.isPending]);

    const handleSend = () => {
        if (!input.trim() || !sessionId) return;
        setChatHistory(prev => [...prev, { role: 'user', content: input }]);
        sendMessageMutation.mutate(input);
        setInput("");
    };

    const handleKeyDown = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    };

    if (!sessionId) return <WelcomeScreen />;

    const queryCount = chatHistory.filter(x => x.role === 'user').length;

    return (
        <div className="flex flex-col h-full w-full bg-background">
            {/* Header */}
            <div className="px-6 py-3 border-b flex items-center justify-between bg-card shadow-sm z-10">
                <div className="flex items-center gap-2">
                    <FileText className="h-5 w-5 text-primary" />
                    <span className="font-medium text-sm">
                        {documents.length > 0 ? (
                            <>
                                {documents.length === 1 ? documents[0].original_filename : `${documents.length} documents`}
                                <span className="text-muted-foreground ml-2">| {queryCount} queries</span>
                            </>
                        ) : (
                            "Active Session"
                        )}
                    </span>
                </div>
            </div>

            {/* Chat Area - UPDATED BG */}
            <div className="flex-1 overflow-hidden relative bg-muted/20">
                <ScrollArea className="h-full px-4 md:px-20 py-4" ref={scrollRef}>
                    <div className="space-y-8 pb-4 max-w-4xl mx-auto min-h-[500px]">
                        {chatHistory.map((msg, idx) => (
                            <div key={idx} className={`flex gap-4 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>

                                {msg.role === 'assistant' && (
                                    // UPDATED BG
                                    <div className="h-10 w-10 rounded-full bg-card p-1 flex items-center justify-center shrink-0 border shadow-sm mt-1">
                                        <img src={doggieSrc} alt="Bot" className="h-full w-full object-contain" />
                                    </div>
                                )}

                                <div className={`flex flex-col max-w-[85%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                    <div className={`px-5 py-4 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user'
                                        ? 'bg-primary text-primary-foreground rounded-br-sm prose-invert'
                                        // UPDATED BG and BORDER
                                        : 'bg-card border rounded-bl-sm text-card-foreground'
                                        }`}>
                                        <ReactMarkdown
                                            components={{
                                                p: ({ node, ...props }) => <p className="mb-2 last:mb-0" {...props} />,
                                                ul: ({ node, ...props }) => <ul className="list-disc pl-4 mb-2 space-y-1" {...props} />,
                                                ol: ({ node, ...props }) => <ol className="list-decimal pl-4 mb-2 space-y-1" {...props} />,
                                                li: ({ node, ...props }) => <li className="" {...props} />,
                                                strong: ({ node, ...props }) => <span className="font-bold" {...props} />,
                                                // Updated Link Color
                                                a: ({ node, ...props }) => <a className="underline font-medium text-primary" target="_blank" {...props} />,
                                                code: ({ node, ...props }) => (
                                                    // Updated Code BG
                                                    <code className="px-1 py-0.5 rounded font-mono text-xs bg-muted text-foreground" {...props} />
                                                ),
                                                pre: ({ node, ...props }) => (
                                                    // Updated Pre Block BG
                                                    <pre className="p-3 rounded-lg overflow-x-auto my-2 bg-muted text-foreground border" {...props} />
                                                ),
                                            }}
                                        >
                                            {msg.content}
                                        </ReactMarkdown>
                                    </div>

                                    {msg.role === 'assistant' && msg.sources && (
                                        <SourceViewer sources={msg.sources} documents={documents} />
                                    )}
                                </div>

                                {msg.role === 'user' && (
                                    <div className="h-10 w-10 rounded-full bg-muted p-1 flex items-center justify-center shrink-0 border shadow-sm mt-1">
                                        <img src={userSrc} alt="User" className="h-full w-full object-cover rounded-full" />
                                    </div>
                                )}
                            </div>
                        ))}

                        {sendMessageMutation.isPending && (
                            <div className="flex gap-4">
                                <div className="h-10 w-10 rounded-full bg-card p-1 flex items-center justify-center shrink-0 border shadow-sm mt-1">
                                    <img src={doggieSrc} alt="Bot" className="h-full w-full object-contain" />
                                </div>
                                <div className="bg-card border px-5 py-4 rounded-2xl rounded-bl-sm text-sm text-muted-foreground flex items-center gap-2 shadow-sm">
                                    <Loader2 className="h-4 w-4 animate-spin" />
                                    <span className="italic">Finding answer...</span>
                                </div>
                            </div>
                        )}
                        <div ref={bottomRef} />
                    </div>
                </ScrollArea>
            </div>

            {/* Input Area - UPDATED BG */}
            <div className="p-4 bg-background border-t">
                <div className="max-w-3xl mx-auto relative flex items-center gap-2">
                    <Input
                        placeholder="Ask a question..."
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={handleKeyDown}
                        // UPDATED BG
                        className="pr-12 py-6 rounded-full shadow-sm text-base bg-card text-card-foreground"
                        disabled={sendMessageMutation.isPending}
                    />
                    <Button
                        size="icon"
                        className="absolute right-2 rounded-full h-10 w-10 shadow-sm"
                        onClick={handleSend}
                        disabled={!input.trim() || sendMessageMutation.isPending}
                    >
                        <Send className="h-4 w-4" />
                    </Button>
                </div>
            </div>
        </div>
    );
};

---- FILE: src/components/ChartBrowser.tsx ----
import React, { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { ChevronLeft, ChevronRight, ImageIcon, Maximize2 } from 'lucide-react';
import { getSessionCharts } from '../lib/api';
import { Card } from '@/components/ui/card';
import { ScrollArea } from '@/components/ui/scroll-area';
import ReactMarkdown from 'react-markdown';


interface ChartBrowserProps {
    sessionId: string | null;
}

export const ChartBrowser: React.FC<ChartBrowserProps> = ({ sessionId }) => {
    const [index, setIndex] = useState(0);

    const { data: allCharts = [] } = useQuery({
        queryKey: ['charts', sessionId],
        queryFn: () => getSessionCharts(sessionId!),
        enabled: !!sessionId,
    });

    if (!sessionId) {
        return <div className="p-4 text-sm text-muted-foreground text-center">Load a session to view charts.</div>;
    }

    if (allCharts.length === 0) {
        return <div className="p-4 text-sm text-muted-foreground text-center">No charts detected in this session.</div>;
    }

    const total = allCharts.length;
    const safeIndex = index >= total ? 0 : index;
    const currentChart = allCharts[safeIndex];

    const handleNext = () => setIndex((prev) => (prev + 1) % total);
    const handlePrev = () => setIndex((prev) => (prev - 1 + total) % total);

    return (
        <div className="flex flex-col h-full">
            {/* Navigation Controls */}
            <div className="flex items-center justify-between p-2 mb-2 bg-muted/40 rounded-lg">
                <Button variant="ghost" size="icon" onClick={handlePrev} className="h-8 w-8">
                    <ChevronLeft className="h-4 w-4" />
                </Button>
                <div className="text-xs font-medium text-center">
                    Chart {safeIndex + 1} / {total}
                </div>
                <Button variant="ghost" size="icon" onClick={handleNext} className="h-8 w-8">
                    <ChevronRight className="h-4 w-4" />
                </Button>
            </div>

            {/* Image Area - UPDATED BG */}
            <Card className="overflow-hidden bg-muted/20 flex items-center justify-center min-h-[200px] max-h-[300px] mb-4 relative group border">
                {currentChart.url ? (
                    <a href={currentChart.url} target="_blank" rel="noopener noreferrer">
                        <img
                            src={currentChart.url}
                            alt="Chart"
                            // Removed bg-white, added p-1
                            className="w-full h-full object-contain"
                        />
                        {/* ... hover icon ... */}
                    </a>
                ) : (
                    <ImageIcon className="h-10 w-10 text-muted-foreground/30" />
                )}
            </Card>

            {/* Metadata */}
            <ScrollArea className="flex-1">
                <div className="space-y-3 px-1">
                    <div>
                        <span className="text-xs font-semibold text-primary">Source Document:</span>
                        <p className="text-xs text-muted-foreground">{currentChart.doc_name} (Page {currentChart.page})</p>
                    </div>

                    <div>
                        <span className="text-xs font-semibold text-primary">AI Description:</span>
                        {/* UPDATED BG */}
                        <div className="mt-1 text-xs text-muted-foreground leading-relaxed bg-muted/40 p-2 rounded border">
                            {currentChart.description || "No description available."}
                        </div>
                    </div>
                </div>
            </ScrollArea>
        </div>
    );
};

---- FILE: src/components/Dashboard.tsx ----
import { useState } from 'react';
import { MainContent } from '../MainContent';
import { Sidebar } from './Sidebar';
import {
    ResizableHandle,
    ResizablePanel,
    ResizablePanelGroup
} from "@/components/ui/resizable";

export const Dashboard = () => {
    const [sessionId, setSessionId] = useState<string | null>(null);

    return (
        <div className="h-screen w-full overflow-hidden bg-background">
            <ResizablePanelGroup direction="horizontal">
                <ResizablePanel
                    defaultSize={25}
                    minSize={15}
                    maxSize={45}
                    className="bg-muted/10 min-w-[280px]"
                >
                    <Sidebar
                        currentSessionId={sessionId}
                        onSessionChange={setSessionId}
                    />
                </ResizablePanel>

                <ResizableHandle withHandle />

                <ResizablePanel defaultSize={75}>
                    <MainContent sessionId={sessionId} />
                </ResizablePanel>
            </ResizablePanelGroup>
        </div>
    );
};

---- FILE: src/components/SideBar.tsx ----
import React, { useState, useEffect } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { Loader2, Upload, LayoutGrid, FileText, CheckCircle2, AlertCircle } from 'lucide-react';
import { getSessions, checkBackendHealth, uploadAndProcessDocument, createSession, getSessionStatus } from '../lib/api';
import { VisionModel } from '../types';
import { cn } from '@/lib/utils';
import { ChartBrowser } from './ChartBrowser';

// UI Components
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import { Progress } from '@/components/ui/progress';
import { Card } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

interface SidebarProps {
    currentSessionId: string | null;
    onSessionChange: (id: string | null) => void;
    className?: string;
}

const VISION_MODELS: { value: VisionModel; label: string; desc: string }[] = [
    { value: "Moondream2", label: "Moondream2 (1.6B)", desc: "Fast - Recommended (Local)" },
    { value: "Qwen3-VL-2B", label: "Qwen3-VL (2B)", desc: "Balanced - High Accuracy" },
    { value: "InternVL3.5-1B", label: "InternVL 3.5 (1B)", desc: "Precise - Doc Optimized" },
    { value: "Ollama-Gemma3", label: "Gemma 3 (4B)", desc: "Strong Reasoning - Requires Ollama" },
    { value: "Ollama-Granite3.2-Vision", label: "Granite 3.2 (2B)", desc: "Enterprise Vision" },
];

export const Sidebar: React.FC<SidebarProps> = ({ currentSessionId, onSessionChange, className }) => {
    const queryClient = useQueryClient();
    const [selectedModel, setSelectedModel] = useState<VisionModel>("Moondream2");

    // UI States
    const [isUploading, setIsUploading] = useState(false);
    const [activeJobId, setActiveJobId] = useState<string | null>(null);

    // Health Check
    const { data: isBackendOnline } = useQuery({
        queryKey: ['health'],
        queryFn: checkBackendHealth,
        refetchInterval: 10000,
    });

    // Load Sessions
    const { data: sessions = [] } = useQuery({
        queryKey: ['sessions'],
        queryFn: getSessions,
        enabled: !!isBackendOnline,
    });

    // --- POLLING STATUS ---
    // Polls backend every 1s if we have an active job ID
    const { data: jobStatus } = useQuery({
        queryKey: ['status', activeJobId],
        queryFn: () => getSessionStatus(activeJobId!),
        enabled: !!activeJobId,
        refetchInterval: 1000, // Poll every second
    });

    // Effect to handle job completion
    useEffect(() => {
        if (jobStatus?.status === 'completed') {
            setActiveJobId(null);
            setIsUploading(false);

            // Refresh data
            queryClient.invalidateQueries({ queryKey: ['sessions'] });
            queryClient.invalidateQueries({ queryKey: ['documents', currentSessionId] });
            queryClient.invalidateQueries({ queryKey: ['charts', currentSessionId] });
        } else if (jobStatus?.status === 'error') {
            setIsUploading(false); // Stop loading UI on error
        }
    }, [jobStatus, queryClient, currentSessionId]);

    const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
        if (!event.target.files || event.target.files.length === 0) return;
        const files = Array.from(event.target.files);

        setIsUploading(true);

        try {
            // 1. Create Session
            const newSessionId = await createSession(files.map(f => f.name));
            onSessionChange(newSessionId);
            setActiveJobId(newSessionId); // Start polling this session

            // 2. Kick off processing (Backend handles queueing)
            for (const file of files) {
                await uploadAndProcessDocument(newSessionId, file, selectedModel);
            }

            // Input clearing
            event.target.value = "";

        } catch (error) {
            console.error(error);
            setIsUploading(false);
            setActiveJobId(null);
        }
    };

    return (
        <div className={cn("flex flex-col h-full w-full bg-muted/10 border-r", className)}>
            <div className="p-4 border-b bg-background flex justify-between items-center shrink-0">
                <h2 className="text-lg font-bold flex items-center gap-2">
                    ðŸ§  Smart RAG
                    <div className={`h-2 w-2 rounded-full ${isBackendOnline ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`} />
                </h2>
            </div>

            <Tabs defaultValue="files" className="flex-1 flex flex-col min-h-0">
                <div className="px-4 py-2 shrink-0">
                    <TabsList className="grid w-full grid-cols-2">
                        <TabsTrigger value="files" className="flex gap-2"><FileText className="w-4 h-4" /> Files</TabsTrigger>
                        <TabsTrigger value="charts" className="flex gap-2"><LayoutGrid className="w-4 h-4" /> Charts</TabsTrigger>
                    </TabsList>
                </div>

                {/* --- FILES TAB --- */}
                <TabsContent value="files" className="flex-1 flex flex-col min-h-0 data-[state=active]:flex">
                    <ScrollArea className="flex-1 px-4 py-2">
                        <div className="space-y-6 pb-6">

                            {/* STATUS CARD (Visible when processing) */}
                            {activeJobId && jobStatus && (
                                <Card className="p-4 border-blue-200 bg-blue-50/50 dark:bg-blue-950/20 animate-in fade-in slide-in-from-top-2">
                                    <div className="flex items-center gap-2 mb-2">
                                        {jobStatus.status === 'completed' ? (
                                            <CheckCircle2 className="h-4 w-4 text-green-600" />
                                        ) : jobStatus.status === 'error' ? (
                                            <AlertCircle className="h-4 w-4 text-red-600" />
                                        ) : (
                                            <Loader2 className="h-4 w-4 animate-spin text-blue-600" />
                                        )}
                                        <span className="font-semibold text-sm">
                                            {jobStatus.status === 'completed' ? 'Success' : 'Processing...'}
                                        </span>
                                    </div>

                                    <Progress value={jobStatus.progress} className="h-2 mb-2" />

                                    <p className="text-xs text-muted-foreground font-mono">
                                        {jobStatus.step}
                                    </p>
                                </Card>
                            )}

                            {/* NEW SESSION UPLOADER */}
                            {!currentSessionId && !activeJobId && (
                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Vision Model</label>
                                        <Select value={selectedModel} onValueChange={(v) => setSelectedModel(v as VisionModel)}>
                                            <SelectTrigger><SelectValue /></SelectTrigger>
                                            <SelectContent>
                                                {VISION_MODELS.map((m) => (
                                                    <SelectItem key={m.value} value={m.value}>
                                                        <div className="flex flex-col items-start">
                                                            <span className="font-medium">{m.label}</span>
                                                            <span className="text-xs text-muted-foreground">{m.desc}</span>
                                                        </div>
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                    </div>

                                    <Card className="p-6 border-dashed border-2 flex flex-col items-center gap-2 text-center hover:bg-muted/50 transition-colors relative cursor-pointer group">
                                        <input
                                            type="file"
                                            multiple
                                            accept=".pdf,.docx,.pptx"
                                            className="absolute inset-0 opacity-0 cursor-pointer z-10"
                                            onChange={handleFileUpload}
                                            disabled={isUploading}
                                        />
                                        <div className="h-10 w-10 rounded-full bg-muted flex items-center justify-center group-hover:scale-110 transition-transform">
                                            <Upload className="h-5 w-5 text-muted-foreground" />
                                        </div>
                                        <div>
                                            <div className="text-sm font-semibold">Click to Upload Documents</div>
                                            <div className="text-xs text-muted-foreground">PDF, DOCX, PPTX</div>
                                        </div>
                                    </Card>
                                </div>
                            )}

                            <Separator />

                            {/* SESSION LIST */}
                            <div className="space-y-2">
                                <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">History</h3>
                                <Select
                                    value={currentSessionId || "new"}
                                    onValueChange={(val) => onSessionChange(val === "new" ? null : val)}
                                    disabled={!!activeJobId} // Disable switching while processing
                                >
                                    <SelectTrigger className="w-full">
                                        <SelectValue placeholder="Select Session" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="new" className="text-primary font-medium">âœ¨ Start New Session</SelectItem>
                                        {sessions.map((sess) => (
                                            <SelectItem key={sess.id} value={String(sess.id)}>
                                                {sess.name.substring(0, 20)}{sess.name.length > 20 && "..."} ({sess.docs})
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            </div>

                        </div>
                    </ScrollArea>
                </TabsContent>

                <TabsContent value="charts" className="flex-1 flex flex-col min-h-0 data-[state=active]:flex overflow-hidden">
                    <div className="flex-1 px-4 py-2 min-h-0">
                        <ChartBrowser sessionId={currentSessionId} />
                    </div>
                </TabsContent>
            </Tabs>
        </div>
    );
};

---- FILE: src/components/SourceViewer.tsx ----
import React from 'react';
import ReactMarkdown from 'react-markdown';
import { SearchResult, SessionDocument } from '../types';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { Card } from '@/components/ui/card';

interface SourceViewerProps {
    sources: SearchResult[];
    documents: SessionDocument[];
}

export const SourceViewer: React.FC<SourceViewerProps> = ({ sources }) => {
    if (!sources || sources.length === 0) return null;

    return (
        <Accordion type="single" collapsible className="w-full mt-2">
            <AccordionItem value="sources" className="border-b-0">
                <AccordionTrigger className="text-sm text-muted-foreground py-2 hover:no-underline hover:text-primary">
                    ðŸ“š View Sources & Related Charts
                </AccordionTrigger>
                <AccordionContent>
                    <div className="space-y-4 pt-2">
                        <h5 className="font-semibold text-sm">ðŸ“„ Text Sources</h5>
                        <div className="grid gap-2">
                            {sources.map((src, idx) => {
                                const score = src.score ? parseFloat(src.score.toString()) : 1;
                                const relevance = (1 / (1 + score)) * 100;
                                const filename = src.source ? src.source.split('/').pop() : 'Unknown';

                                return (
                                    <Card key={idx} className="p-3 text-sm bg-muted/50 border-none shadow-sm">
                                        <div className="font-medium mb-2 text-xs text-blue-500 flex justify-between">
                                            <span>Source {idx + 1} (from {filename} - Page {src.page || 'N/A'})</span>
                                            <span>Relevance: {relevance.toFixed(1)}%</span>
                                        </div>
                                        <div className="text-muted-foreground text-xs leading-relaxed">
                                            {/* Safe Markdown usage */}
                                            <ReactMarkdown
                                                components={{
                                                    p: ({ node, ...props }) => <p className="mb-1 last:mb-0" {...props} />,
                                                    strong: ({ node, ...props }) => <span className="font-semibold text-foreground" {...props} />,
                                                }}
                                            >
                                                {src.text}
                                            </ReactMarkdown>
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    </div>
                </AccordionContent>
            </AccordionItem>
        </Accordion>
    );
};

---- FILE: src/components/ui/accordion.tsx ----
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))
AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


---- FILE: src/components/ui/button.tsx ----
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }


---- FILE: src/components/ui/card.tsx ----
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


---- FILE: src/components/ui/input.tsx ----
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


---- FILE: src/components/ui/progress.tsx ----
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
    React.ElementRef<typeof ProgressPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
    <ProgressPrimitive.Root
        ref={ref}
        className={cn(
            "relative h-2 w-full overflow-hidden rounded-full bg-primary/20",
            className
        )}
        {...props}
    >
        <ProgressPrimitive.Indicator
            className="h-full w-full flex-1 bg-primary transition-all"
            style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
        />
    </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }

---- FILE: src/components/ui/resizable.tsx ----
import { GripVertical } from "lucide-react"
import { Panel, PanelGroup, PanelResizeHandle } from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof PanelGroup>) => (
  <PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
)

const ResizablePanel = Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof PanelResizeHandle> & {
  withHandle?: boolean
}) => (
  <PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }

---- FILE: src/components/ui/scroll-area.tsx ----
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


---- FILE: src/components/ui/select.tsx ----
import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Trigger>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
    <SelectPrimitive.Trigger
        ref={ref}
        className={cn(
            "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
            className
        )}
        {...props}
    >
        {children}
        <SelectPrimitive.Icon asChild>
            <ChevronDown className="h-4 w-4 opacity-50" />
        </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.ScrollUpButton
        ref={ref}
        className={cn(
            "flex cursor-default items-center justify-center py-1",
            className
        )}
        {...props}
    >
        <ChevronUp className="h-4 w-4" />
    </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.ScrollDownButton
        ref={ref}
        className={cn(
            "flex cursor-default items-center justify-center py-1",
            className
        )}
        {...props}
    >
        <ChevronDown className="h-4 w-4" />
    </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
    SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
    <SelectPrimitive.Portal>
        <SelectPrimitive.Content
            ref={ref}
            className={cn(
                "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                position === "popper" &&
                "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
                className
            )}
            position={position}
            {...props}
        >
            <SelectScrollUpButton />
            <SelectPrimitive.Viewport
                className={cn(
                    "p-1",
                    position === "popper" &&
                    "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
                )}
            >
                {children}
            </SelectPrimitive.Viewport>
            <SelectScrollDownButton />
        </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Label>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.Label
        ref={ref}
        className={cn("px-2 py-1.5 text-sm font-semibold", className)}
        {...props}
    />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Item>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
    <SelectPrimitive.Item
        ref={ref}
        className={cn(
            "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        {...props}
    >
        <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
            <SelectPrimitive.ItemIndicator>
                <Check className="h-4 w-4" />
            </SelectPrimitive.ItemIndicator>
        </span>
        <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Separator>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.Separator
        ref={ref}
        className={cn("-mx-1 my-1 h-px bg-muted", className)}
        {...props}
    />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
    Select,
    SelectGroup,
    SelectValue,
    SelectTrigger,
    SelectContent,
    SelectLabel,
    SelectItem,
    SelectSeparator,
    SelectScrollUpButton,
    SelectScrollDownButton,
}

---- FILE: src/components/ui/separator.tsx ----
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


---- FILE: src/components/ui/skeleton.tsx ----
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-primary/10", className)}
      {...props}
    />
  )
}

export { Skeleton }


---- FILE: src/components/ui/tabs.tsx ----
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-lg bg-muted/30 p-1 text-muted-foreground gap-1",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
      // Inactive state - transparent with muted text
      "text-muted-foreground bg-transparent hover:text-foreground hover:bg-background/60",
      // Active state - solid background that stands out
      "data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm data-[state=active]:font-semibold",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }

---- FILE: src/index.css ----
@import "tailwindcss";
@import "tw-animate-css";

@layer base {
  :root {
    /* ... (keep all your existing color variables) ... */
    --background: 40 20% 96%;
    --foreground: 220 20% 15%;
    --card: 40 15% 98%;
    --card-foreground: 220 20% 15%;
    --popover: 40 15% 98%;
    --popover-foreground: 220 20% 15%;
    --primary: 220 70% 45%;
    --primary-foreground: 0 0% 98%;
    --secondary: 40 25% 90%;
    --secondary-foreground: 220 20% 15%;
    --muted: 40 20% 92%;
    --muted-foreground: 220 15% 45%;
    --accent: 40 25% 90%;
    --accent-foreground: 220 20% 15%;
    --destructive: 0 72% 51%;
    --destructive-foreground: 0 0% 98%;
    --border: 40 20% 88%;
    --input: 40 20% 88%;
    --ring: 220 70% 45%;
    --radius: 0.5rem;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      /* ... (keep existing dark variables) ... */
      --background: 220 45% 12%;
      --foreground: 210 30% 96%;
      --card: 220 40% 15%;
      --card-foreground: 210 30% 96%;
      --popover: 220 40% 15%;
      --popover-foreground: 210 30% 96%;
      --primary: 210 80% 65%;
      --primary-foreground: 220 45% 12%;
      --secondary: 220 35% 20%;
      --secondary-foreground: 210 30% 96%;
      --muted: 220 35% 20%;
      --muted-foreground: 210 20% 70%;
      --accent: 220 35% 22%;
      --accent-foreground: 210 30% 96%;
      --destructive: 0 72% 51%;
      --destructive-foreground: 210 30% 96%;
      --border: 220 35% 20%;
      --input: 220 35% 22%;
      --ring: 210 80% 65%;
    }
  }

  * {
    @apply border-border;
  }

  html,
  body,
  #root {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    @apply bg-background text-foreground;
  }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  /* --- ADD THIS NEW BLOCK --- */
  /* Restore the pointer cursor for all interactive elements */
  button,
  [role="button"],
  a,
  input[type="submit"],
  input[type="button"] {
    cursor: pointer;
  }

  /* Keep 'not-allowed' cursor for disabled elements */
  button:disabled,
  button[aria-disabled="true"],
  input:disabled {
    cursor: not-allowed;
  }
}

@theme {
  /* ... (keep your existing theme config) ... */
  --color-background: hsl(var(--background));
  --color-foreground: hsl(var(--foreground));
  --color-card: hsl(var(--card));
  --color-card-foreground: hsl(var(--card-foreground));
  --color-popover: hsl(var(--popover));
  --color-popover-foreground: hsl(var(--popover-foreground));
  --color-primary: hsl(var(--primary));
  --color-primary-foreground: hsl(var(--primary-foreground));
  --color-secondary: hsl(var(--secondary));
  --color-secondary-foreground: hsl(var(--secondary-foreground));
  --color-muted: hsl(var(--muted));
  --color-muted-foreground: hsl(var(--muted-foreground));
  --color-accent: hsl(var(--accent));
  --color-accent-foreground: hsl(var(--accent-foreground));
  --color-destructive: hsl(var(--destructive));
  --color-destructive-foreground: hsl(var(--destructive-foreground));
  --color-border: hsl(var(--border));
  --color-input: hsl(var(--input));
  --color-ring: hsl(var(--ring));
  --radius-sm: calc(var(--radius) - 2px);
  --radius-md: var(--radius);
  --radius-lg: calc(var(--radius) + 2px);
  --radius-xl: calc(var(--radius) + 4px);
}

@plugin "tailwindcss-animate";

---- FILE: src/lib/api.ts ----
import axios from 'axios';
import { SessionDocument, QueryResponse, SessionSummary } from '../types';


const API_BASE = 'http://localhost:8000';
export const api = axios.create({ baseURL: API_BASE, timeout: 120000 });



// --- System Health ---
export const checkBackendHealth = async (): Promise<boolean> => {
    try {
        await api.get('/docs', { timeout: 2000 });
        return true;
    } catch (e) {
        return false;
    }
};

export interface JobStatus {
    status: 'idle' | 'queued' | 'processing' | 'completed' | 'error';
    step: string;
    progress: number;
}

export const getSessionCharts = async (sessionId: string) => {
    try {
        const { data } = await api.get(`/sessions/${sessionId}/charts`);
        return data;
    } catch (e) {
        console.error("Failed to fetch charts", e);
        return [];
    }
};

export const getSessionStatus = async (sessionId: string): Promise<JobStatus> => {
    try {
        const { data } = await api.get(`/sessions/${sessionId}/status`);
        return data;
    } catch (e) {
        return { status: 'error', step: 'Connection failed', progress: 0 };
    }
};

// --- Sessions ---
export const getSessions = async (): Promise<SessionSummary[]> => {
    try {
        const { data } = await api.get('/sessions');
        return data;
    } catch (e) {
        console.error("Failed to fetch sessions", e);
        return [];
    }
};

export const createSession = async (filenames: string[]): Promise<string> => {
    const { data } = await api.post('/sessions', { filenames });
    return data.session_id;
};

export const getSessionHistory = async (sessionId: string) => {
    try {
        const { data } = await api.get(`/sessions/${sessionId}/history`);
        return data;
    } catch (e) {
        return [];
    }
};

export const fetchSessionDocuments = async (sessionId: string): Promise<SessionDocument[]> => {
    try {
        const { data } = await api.get(`/sessions/${sessionId}/documents`);
        return data;
    } catch (e) {
        return [];
    }
};

export const uploadAndProcessDocument = async (sessionId: string, file: File, visionModel: string) => {
    const formData = new FormData();
    formData.append('file', file);
    await api.post('/upload', formData, { headers: { 'Content-Type': 'multipart/form-data' } });

    // This returns immediately now
    const { data } = await api.post('/process', {
        session_id: sessionId,
        filename: file.name,
        vision_model: visionModel
    });
    return data;
};

// --- Chat ---
export const sendQuery = async (sessionId: string, question: string): Promise<QueryResponse> => {
    const { data } = await api.post('/query', { session_id: sessionId, question });
    return data;
};

// --- Images ---
export const getChartImageUrl = (chartDir: string | undefined, filename: string) => {
    if (!chartDir) return '';
    // Convert local docker path "/app/data/charts/..." to URL "http://localhost:8000/static/charts/..."
    // The backend mounts "/app/data" to "/static"
    // We strip the "/app/data" prefix if present
    const relativePath = chartDir.replace('/app/data/', '');
    return `${API_BASE}/static/${relativePath}/${filename}`;
};

---- FILE: src/lib/utils.ts ----
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


---- FILE: src/main.tsx ----
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


---- FILE: src/pages/HowItWorks.tsx ----
import React from 'react';
import { Link } from 'react-router-dom';
import { ArrowLeft, Eye, Layers, Database, Cpu, FileText } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export const HowItWorks = () => {
    return (
        <div className="min-h-screen bg-background text-foreground p-6 md:p-12">
            <div className="max-w-4xl mx-auto space-y-12">

                {/* Header & Back Button */}
                <div className="space-y-6">
                    <Link to="/">
                        <Button variant="ghost" className="gap-2 pl-0 hover:bg-transparent hover:text-primary">
                            <ArrowLeft className="h-4 w-4" /> Back
                        </Button>
                    </Link>
                    <h1 className="text-4xl font-extrabold tracking-tight lg:text-5xl">
                        How Smart RAG Works
                    </h1>
                    <p className="text-xl text-muted-foreground">
                        Moving beyond naive implementation to a robust, vision-aware document intelligence system.
                    </p>
                </div>

                {/* Section 1: What is RAG? */}
                <section className="space-y-4">
                    <h2 className="text-2xl font-bold border-b pb-2">1. What is RAG?</h2>
                    <p className="leading-relaxed">
                        <strong>Retrieval-Augmented Generation (RAG)</strong> is a technique that enhances Large Language Models (LLMs) by giving them access to your specific data. Instead of relying solely on what the AI learned during training, RAG retrieves relevant information from your documents and inserts it into the prompt, allowing the AI to answer questions about private data accurately.
                    </p>
                </section>

                {/* Section 2: Our Improvements */}
                <section className="space-y-6">
                    <h2 className="text-2xl font-bold border-b pb-2">2. Our "Smart" Improvements</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <Card>
                            <CardHeader className="flex flex-row items-center gap-4 pb-2">
                                <div className="h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                                    <Eye className="h-6 w-6" />
                                </div>
                                <CardTitle className="text-lg">Vision-Aware Processing</CardTitle>
                            </CardHeader>
                            <CardContent className="text-sm text-muted-foreground leading-relaxed">
                                Standard RAG ignores images. We use dedicated Vision Models (like <strong>Moondream2</strong> or <strong>Qwen-VL</strong>) to "look" at every chart, graph, and diagram in your PDF. We generate textual descriptions of these visuals so the LLM can "read" your charts just like text.
                            </CardContent>
                        </Card>

                        <Card>
                            <CardHeader className="flex flex-row items-center gap-4 pb-2">
                                <div className="h-10 w-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400">
                                    <Layers className="h-6 w-6" />
                                </div>
                                <CardTitle className="text-lg">Parent-Child Chunking</CardTitle>
                            </CardHeader>
                            <CardContent className="text-sm text-muted-foreground leading-relaxed">
                                Naive RAG splits text into arbitrary small pieces, often losing context. We use a <strong>Parent-Child strategy</strong>: we search using small, precise "child" chunks, but we feed the "parent" (larger surrounding context) to the LLM. This ensures the answer is comprehensive.
                            </CardContent>
                        </Card>

                        <Card>
                            <CardHeader className="flex flex-row items-center gap-4 pb-2">
                                <div className="h-10 w-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400">
                                    <Database className="h-6 w-6" />
                                </div>
                                <CardTitle className="text-lg">Hybrid Search (Vector + DB)</CardTitle>
                            </CardHeader>
                            <CardContent className="text-sm text-muted-foreground leading-relaxed">
                                We maintain a structured SQL database alongside our FAISS vector store. This allows us to track metadata, manage sessions, and persist chart descriptions separately from raw embeddings, providing a robust history and retrieval system.
                            </CardContent>
                        </Card>

                        <Card>
                            <CardHeader className="flex flex-row items-center gap-4 pb-2">
                                <div className="h-10 w-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400">
                                    <Cpu className="h-6 w-6" />
                                </div>
                                <CardTitle className="text-lg">Microservice Architecture</CardTitle>
                            </CardHeader>
                            <CardContent className="text-sm text-muted-foreground leading-relaxed">
                                The app is split into specialized services: <strong>Parser</strong> (Layout Analysis), <strong>Vision</strong> (GPU-accelerated Inference), and <strong>Core</strong> (Orchestration). This ensures heavy AI jobs don't block the chat interface.
                            </CardContent>
                        </Card>

                    </div>
                </section>

                {/* Section 3: The Pipeline */}
                <section className="space-y-4">
                    <h2 className="text-2xl font-bold border-b pb-2">3. The Pipeline Flow</h2>
                    <div className="bg-muted/30 p-6 rounded-xl border space-y-4 font-mono text-sm">
                        <div className="flex items-center gap-2">
                            <FileText className="h-4 w-4 text-primary" />
                            <span>1. Document Upload &rarr; Sent to Parser Service</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <Eye className="h-4 w-4 text-primary" />
                            <span>2. Images Extracted &rarr; Vision Model generates descriptions</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <Layers className="h-4 w-4 text-primary" />
                            <span>3. Text + Image Descriptions &rarr; Chunked & Embedded into FAISS</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <Database className="h-4 w-4 text-primary" />
                            <span>4. User Query &rarr; Retrieved Context &rarr; LLM Answer</span>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    );
};

---- FILE: src/types.ts ----
export interface SessionDocument {
    id?: string;
    original_filename: string;
    vision_model_used?: string;
    chart_dir?: string;
    chart_descriptions?: string | Record<string, string>;
    chart_descriptions_json?: string | Record<string, string>;
}

export interface SearchResult {
    text: string;
    source: string;
    page?: number;
    score?: number;
}

export interface ChatMessage {
    role: 'user' | 'assistant';
    content: string;
    sources?: SearchResult[];
}

export interface QueryResponse {
    response: string;
    results: SearchResult[];
    error?: string;
}

---- FILE: tailwind.config.js ----
// tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
    content: [
        "./index.html",
        "./src/**/*.{js,ts,jsx,tsx}",
    ],
    theme: {
        extend: {},
    },
    plugins: [],
}

---- FILE: tsconfig.app.json ----
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": [
      "ES2020",
      "DOM",
      "DOM.Iterable"
    ],
    "module": "ESNext",
    "skipLibCheck": true,
    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    /* ADD THIS SECTION BELOW */
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "include": [
    "src"
  ]
}

---- FILE: tsconfig.json ----
{
  "files": [],
  "references": [
    {
      "path": "./tsconfig.app.json"
    },
    {
      "path": "./tsconfig.node.json"
    }
  ],
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  }
}

---- FILE: tsconfig.node.json ----
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


---- FILE: vite.config.ts ----
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import path from "path"

export default defineConfig({
  plugins: [
    react(),
    tailwindcss(), // <--- Add this
  ],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
})

