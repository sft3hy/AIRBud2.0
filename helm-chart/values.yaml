# Global settings
nameOverride: ""
fullnameOverride: "airbud"

global:
  storageClass: "cosmichorizon-ebs-sc-retain"
  storageClassShared: "cosmichorizon-efs-sc"
  testMode: "False"
  persistence:
    enabled: true 
  ephemeralMode: false
  # Auth Mode: "CAC" or "OAUTH"
  authMode: "CAC"
  # If defined, use this existing secret instead of creating one from values
  existingSecret: "airbud-secrets" 

offline:
  enabled: true
  pvcName: "airbud-offline-models" # Pre-existing PVC for models

externalSecrets:
  groq:
    secretName: "groq-api-key"
    key: "GROQ_API_KEY"
  sanctuary:
    secretName: "sanctuary"
    key: "SANCTUARY_API_KEY"

sharedData:
  size: 5Gi

nodeSelector:
  project: cosmichorizon

tolerations:
  - key: "karpenter-cpu"
    operator: "Equal"
    effect: "NoSchedule"
    value: "true"
  - key: "project"
    operator: "Equal"
    effect: "NoSchedule"
    value: "cosmichorizon"

tolerationsGPU:
  - key: "nvidia.com/gpu"
    operator: "Equal"
    effect: "NoSchedule"
    value: "true"
  - key: "project"
    operator: "Equal"
    effect: "NoSchedule"
    value: "cosmichorizon"

affinity:
  podAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: component
            operator: In
            values:
            - rag-core
            - parser
            - vision
        topologyKey: "kubernetes.io/hostname"

affinityGPU:
  podAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: component
          operator: In
          values:
          - rag-core
          - parser
          - vision
      topologyKey: "kubernetes.io/hostname"

# ----------------------
# Gateway
# ----------------------
gateway:
  replicaCount: 1
  cacEnabled: true

  image:
    repository: nginx
    tag: alpine

  service:
    type: NodePort
    port: 443
    nodePort: 30051   # must be 30000â€“32767

  tls:
    serverSecretName: "airbud-server-cert"
    clientCaSecretName: "airbud-client-ca"

  resources:
    limits:
      cpu: "500m"
      memory: "256Mi"
    requests:
      cpu: "100m"
      memory: "128Mi"

# ----------------------
# OAuth2 Proxy
# ----------------------
oauth2Proxy:
  enabled: false
  replicaCount: 1
  image:
    repository: quay.io/oauth2-proxy/oauth2-proxy
    tag: v7.4.0
  config:
    # Use existingSecret for clientID/clientSecret/cookieSecret
    # Or define them here if not using existingSecret
    host: "https://test-cosmichorizon-worker-68a3110f01feebd0.elb.us-gov-west-1.amazonaws.com"
    emailDomains: "*"
    cookieSecret: "S0m3V3ryS3cr3tC00k13S3cr3t==" # Placeholder
  resources:
    limits:
      cpu: "200m"
      memory: "128Mi"
    requests:
      cpu: "100m"
      memory: "64Mi"

# ----------------------
# Ingress (CAC passthrough)
# ----------------------
ingress:
  enabled: true
  className: "cosmichorizon-nginx"

  # Needed for external-dns annotation
  externalDnsTarget: test-cosmichorizon-worker-68a3110f01feebd0.elb.us-gov-west-1.amazonaws.com

  annotations:
    cert-manager.io/issuer: "airbud-selfsigned"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/proxy-ssl-verify: "off"
    # Client Certificate Auth
    nginx.ingress.kubernetes.io/auth-tls-verify-client: "on"
    nginx.ingress.kubernetes.io/auth-tls-verify-depth: "4"
    nginx.ingress.kubernetes.io/auth-tls-secret: "cosmichorizon/airbud-client-ca"
    nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream: "true"

  hosts:
    - host: test-cosmichorizon-worker-68a3110f01feebd0.elb.us-gov-west-1.amazonaws.com
      paths:
        - path: /airbud
          pathType: Prefix

  tls:
    - hosts:
        - test-cosmichorizon-worker-68a3110f01feebd0.elb.us-gov-west-1.amazonaws.com
      secretName: airbud-server-cert

# ----------------------
# Frontend
# ----------------------
frontend:
  replicaCount: 1
  image:
    repository: harbor.i2cv.io/cosmichorizon/airbud-frontend
    tag: latest
    pullPolicy: Always
  env:
    viteApiUrl: "https://test-cosmichorizon-worker-68a3110f01feebd0.elb.us-gov-west-1.amazonaws.com/airbud"
    viteNetwork: "LOW"
  resources:
    limits:
      cpu: "500m"
      memory: "512Mi"
    requests:
      cpu: "100m"
      memory: "128Mi"

# ----------------------
# RAG Core
# ----------------------
ragCore:
  replicaCount: 1
  image:
    repository: harbor.i2cv.io/cosmichorizon/airbud-core
    tag: latest
    pullPolicy: Always
  env:
    llmProvider: "sanctuary"
    postgresUser: "rag_user"
    postgresDb: "rag_db"
  resources:
    limits:
      cpu: "1"
      memory: "4Gi"
    requests:
      cpu: "500m"
      memory: "2Gi"

# ----------------------
# Vision (GPU)
# ----------------------
vision:
  replicaCount: 1
  image:
    repository: harbor.i2cv.io/cosmichorizon/airbud-vision
    tag: latest
  env:
    ollamaBaseUrl: "http://airbud-ollama:11434"
  gpu:
    enabled: true
    count: 1
  resources:
    limits:
      nvidia.com/gpu: 1
      cpu: "2"
      memory: "4Gi"
    requests:
      cpu: "1"
      memory: "2Gi"

# ----------------------
# Ollama (GPU)
# ----------------------
ollama:
  enabled: true
  replicaCount: 1
  image:
    repository: ollama/ollama
    tag: latest
    pullPolicy: IfNotPresent
  gpu:
    enabled: true
    count: 1
  resources:
    limits:
      nvidia.com/gpu: 1
      cpu: "2"
      memory: "8Gi"
    requests:
      cpu: "1"
      memory: "4Gi"
  persistence:
    enabled: true
    size: 50Gi
    storageClass: "" # uses global.storageClass if empty

# ----------------------
# Parser
# ----------------------
parser:
  replicaCount: 1
  image:
    repository: harbor.i2cv.io/cosmichorizon/airbud-parser
    tag: latest
    pullPolicy: Always
  gpu:
    enabled: true
    count: 1
  workers: 1
  resources:
    limits:
      nvidia.com/gpu: 1
      cpu: "1"
      memory: "6Gi"
    requests:
      cpu: "500m"
      memory: "4Gi"

# ----------------------
# KG Service
# ----------------------
kgService:
  enabled: true
  replicaCount: 1
  image:
    repository: harbor.i2cv.io/cosmichorizon/airbud-kg
    tag: latest
  resources:
    limits:
      cpu: "500m"
      memory: "1Gi"
    requests:
      cpu: "200m"
      memory: "512Mi"

# ----------------------
# Monitoring Stack (DISABLED)
# ----------------------
monitor:
  enabled: false
  resources:
    limits:
      cpu: "200m"
      memory: "256Mi"
    requests:
      cpu: "100m"
      memory: "128Mi"

pgadmin:
  enabled: false
  image: dpage/pgadmin4
  email: "admin@example.com"
  storage: 1Gi
  resources:
    limits:
      cpu: "200m"
      memory: "256Mi"

influxdb:
  enabled: false
  image: influxdb:2.7
  storage: 5Gi
  org: "smartrag_org"
  bucket: "glances"

grafana:
  enabled: false
  image: grafana/grafana:latest
  storage: 2Gi

postgres:
  enabled: true
  image: postgres:15-alpine
  storage: 10Gi
  resources:
    limits:
      cpu: "500m"
      memory: "1Gi"
    requests:
      cpu: "200m"
      memory: "512Mi"

neo4j:
  enabled: true
  image: neo4j:5.15-community
  storage: 10Gi
  env:
    heapInitial: "512m"
    heapMax: "1G"
  resources:
    limits:
      cpu: "1"
      memory: "2Gi"
    requests:
      cpu: "500m"
      memory: "1Gi"

backup:
  enabled: false
  schedule: "0 0 * * 3"
  image:
    repository: harbor.i2cv.io/cosmichorizon/airbud-backups
    tag: latest
  env:
    tz: "America/New_York"

imagePullSecrets:
  - name: s-hxl2n

