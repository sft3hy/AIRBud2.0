apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "airbud.fullname" . }}-gateway-conf
data:
  no-cert.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head><title>Authentication Required</title></head>
    <body><h1>Smart Card Required</h1><p>Access denied. Insert CAC/PIV.</p></body>
    </html>



  nginx.conf: |
    error_log /var/log/nginx/error.log debug;
    events { worker_connections 2048; }
    http {
        include mime.types;
        default_type application/octet-stream;
        sendfile on;
        client_max_body_size 500M;
        
        # Increase buffer size for large headers (Certificates)
        client_header_buffer_size 32k;
        large_client_header_buffers 4 32k;

        upstream frontend { server {{ include "airbud.fullname" . }}-frontend:80; }
        upstream rag_core { server {{ include "airbud.fullname" . }}-rag-core:8000; }
        {{- if .Values.kgService.enabled }}
        upstream kg_service { server {{ include "airbud.fullname" . }}-kg-service:8003; }
        {{- end }}
        {{- if eq .Values.global.authMode "OAUTH" }}
        upstream oauth2_proxy { server {{ include "airbud.fullname" . }}-oauth2-proxy:4180; }
        {{- end }}

        server {
            listen 80;
            listen 443 ssl;
            server_name localhost;

            ssl_certificate     /etc/nginx/certs/server.crt;
            ssl_certificate_key /etc/nginx/certs/server.key;
            
            {{- if .Values.gateway.cacEnabled }}
            # Check header passed by Ingress (X-SSL-Client-Verify)
            # Ingress sets this to 'SUCCESS', 'FAILED: reason', or 'NONE'
            if ($http_x_ssl_client_verify != "SUCCESS") {
                add_header Content-Type text/plain;
                return 200 "CAC Verification Failed: $http_x_ssl_client_verify\nCN: $http_x_ssl_client_dn";
            }
            {{- end }}

            location = /no-cert.html {
                root /usr/share/nginx/html;
                internal;
            }

            {{- if eq .Values.global.authMode "OAUTH" }}
            location /oauth2/ {
                proxy_pass       http://oauth2_proxy;
                proxy_set_header Host                    $host;
                proxy_set_header X-Real-IP               $remote_addr;
                proxy_set_header X-Scheme                $scheme;
                proxy_set_header X-Auth-Request-Redirect $request_uri;
            }

            location = /oauth2/auth {
                proxy_pass       http://oauth2_proxy;
                proxy_set_header Host                    $host;
                proxy_set_header X-Real-IP               $remote_addr;
                proxy_set_header X-Scheme                $scheme;
                proxy_set_header Content-Length          "";
                proxy_pass_request_body                  off;
            }
            {{- end }}

            location /airbud/ {
                {{- if eq .Values.global.authMode "OAUTH" }}
                auth_request /oauth2/auth;
                error_page 401 = /oauth2/start?rd=$request_uri;
                {{- end }}
                rewrite ^/airbud/(.*) /$1 break;
                proxy_pass http://frontend;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
            }

            location /airbud/api/ {
                {{- if eq .Values.global.authMode "OAUTH" }}
                auth_request /oauth2/auth;
                error_page 401 = /oauth2/start?rd=$request_uri;
                {{- end }}
                rewrite ^/airbud/api/(.*) /$1 break;
                proxy_pass http://rag_core;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                {{- if .Values.gateway.cacEnabled }}
                proxy_set_header X-Subject-DN $http_x_ssl_client_dn;
                proxy_set_header X-Client-Verify "SUCCESS";
                {{- else if eq .Values.global.authMode "OAUTH" }}
                auth_request_set $user   $upstream_http_x_auth_request_user;
                auth_request_set $email  $upstream_http_x_auth_request_email;
                proxy_set_header X-Auth-Request-User  $user;
                proxy_set_header X-Auth-Request-Email $email;
                # Compatibility with CAC headers for the backend
                proxy_set_header X-Subject-DN "EMAIL=$email,CN=$user";
                proxy_set_header X-Client-Verify "SUCCESS";
                {{- else }}
                # Bypass Mode: Inject Mock CAC Headers
                proxy_set_header X-Subject-DN "CN=Admin User.1234567890,OU=CONTRACTOR,O=U.S. Government";
                proxy_set_header X-Client-Verify "SUCCESS";
                {{- end }}
            }

            location /airbud/static/ {
                # Proxy static assets (charts, images) to RAG Core
                rewrite ^/airbud/static/(.*) /static/$1 break;
                proxy_pass http://rag_core;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
            }

            {{- if .Values.kgService.enabled }}
            location /airbud/graph-api/ {
                rewrite ^/airbud/graph-api/(.*) /$1 break;
                proxy_pass http://kg_service;
            }
            {{- end }}
        }
    }