apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "smart-rag.fullname" . }}-gateway-conf
data:
  no-cert.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head><title>Authentication Required</title></head>
    <body><h1>Smart Card Required</h1><p>Access denied. Insert CAC/PIV.</p></body>
    </html>

  nginx.conf: |
    events { worker_connections 2048; }
    http {
        include mime.types;
        default_type application/octet-stream;
        sendfile on;

        upstream frontend { server {{ include "smart-rag.fullname" . }}-frontend:5173; }
        upstream rag_core { server {{ include "smart-rag.fullname" . }}-rag-core:8000; }
        upstream kg_service { server {{ include "smart-rag.fullname" . }}-kg-service:8003; }

        server {
            listen 443 ssl http2;
            server_name localhost;

            ssl_certificate     /etc/nginx/certs/server.crt;
            ssl_certificate_key /etc/nginx/certs/server.key;
            ssl_client_certificate /etc/nginx/certs/trust_chain.pem;
            ssl_verify_client on;
            ssl_verify_depth 5;
            
            error_page 495 496 400 = /no-cert.html;

            location = /no-cert.html {
                root /usr/share/nginx/html;
                internal;
            }

            location / {
                proxy_pass http://frontend;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
            }

            location /api/ {
                rewrite ^/api/(.*) /$1 break;
                proxy_pass http://rag_core;
                proxy_set_header X-Subject-DN $ssl_client_s_dn;
                proxy_set_header X-Client-Verify $ssl_client_verify;
            }

            location /graph-api/ {
                rewrite ^/graph-api/(.*) /$1 break;
                proxy_pass http://kg_service;
            }
        }
    }